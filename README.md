# Hauzisha — Real Estate Platform

## Overview

Hauzisha is a real estate platform for agents, promoters, and admins to manage property listings, track inquiries through a sales pipeline, attribute leads via tracking links, and automatically calculate commissions.

## Architecture

- **Frontend**: React + Vite (port 8000) — `webapp/`
- **Backend**: Hono + Bun (port 3000) — `backend/`
- **Database**: SQLite via Prisma ORM — `backend/prisma/dev.db`
- **Auth**: Better Auth (email + password)

---

## Backend

### Database Models

| Model | Description |
|---|---|
| `User` | Accounts with roles: `ADMIN`, `AGENT`, `PROMOTER`. Includes approval status, permissions JSON, and referrer link. |
| `Listing` | Property listings. Number starts at 240226. Slug auto-generated as `{type}-for-{rent\|sale}-in-{location}-{number}`. |
| `TrackingLink` | Shareable links with a 12-char secure `refCode`. Tracks clicks and inquiries per platform. |
| `Inquiry` | Client leads linked to a listing and agent. Includes stage pipeline and full stage history. |
| `Promotion` | One record per promoter per listing they're promoting. |
| `Commission` | Auto-created when inquiry reaches `RENTED` or `PURCHASED`. Deleted if stage reverses. |
| `ClickEvent` | Records per-visitor click events (SHA-256 hashed identity) for 10-minute deduplication. |
| `Notification` | In-app notifications per user. Promoter/recruiter notifications never include client details. |
| `SystemSetting` | Key-value config: recruiter bonus, SLA hours, stale inquiry threshold. |

### Roles

- **ADMIN**: Full access to all data and settings.
- **AGENT**: Manages own listings and inquiries with full client details.
- **PROMOTER**: Sees own tracking links, promotions, and commissions — never client details.

### Listing Numbers

Numbers start at **240226** and increment. The `getNextListingNumber()` utility in `src/lib/listings.ts` queries the current max and adds 1.

### Slug Format

```
{propertyType}-for-{rent|sale}-in-{location}-{listingNumber}
```
Example: `apartment-for-rent-in-westlands-240226`

`RENTAL` → `rent`, `SALE` → `sale`. Location is lowercased with spaces replaced by hyphens.

### Tracking Link Ref Codes

Generated by `generateRefCode()` in `src/lib/listings.ts` using `crypto.getRandomValues()` — 12-char URL-safe base64, 72 bits of entropy.

### Commission Logic

Triggered in `src/lib/commissions.ts` when inquiry stage transitions to `RENTED` or `PURCHASED`:
- Agent: `price × agentCommissionPct%`
- Company: `price × companyCommissionPct%`
- Promoter (if attributed): `price × promoterCommissionPct%`
- Recruiter (if agent was referred and bonus toggle is on): flat KES amount from `SystemSetting`

If stage reverses from `RENTED`/`PURCHASED`, all commissions for that inquiry are deleted.

### System Settings (defaults)

| Key | Default | Description |
|---|---|---|
| `recruiter_bonus_enabled` | `true` | Toggle recruiter bonus on/off |
| `recruiter_bonus_amount` | `500` | KES bonus per conversion |
| `agent_response_sla_hours` | `2` | Target first response within N hours |
| `stale_inquiry_threshold_days` | `3` | Flag inquiry as stale after N days |

### Auth

- Email + password via Better Auth
- Session middleware populates `c.get("user")` and `c.get("session")` on all routes
- Auth endpoints at `/api/auth/*`

### Admin Account

- Email: `admin@hauzisha.co.ke`
- Password: `Admin@2026`
- Role: `ADMIN`, fully approved, all permissions

### Key Source Files

```
backend/src/
  auth.ts              — Better Auth configuration
  prisma.ts            — PrismaClient singleton + SQLite pragmas
  env.ts               — Environment variable validation
  index.ts             — Hono app, CORS, auth middleware, routes
  lib/
    listings.ts        — getNextListingNumber(), generateSlug(), generateRefCode(), hashVisitor()
    commissions.ts     — createCommissions(), deleteCommissions()
    notifications.ts   — createNotification()
    settings.ts        — getSetting(), setSetting()
  routes/              — API route handlers (to be added per feature)
backend/prisma/
  schema.prisma        — Full Prisma schema (all 9 models)
  dev.db               — SQLite database file
```

---

## Frontend

Located in `webapp/`. React + Vite + TailwindCSS + shadcn/ui.

### Design System

- **Fonts:** Playfair Display (headings, italic brand name) + DM Sans (body)
- **Primary:** Royal blue `hsl(221 83% 53%)`
- **Accent:** Gold `hsl(43 96% 56%)`
- **Theme:** Light mode with premium, trustworthy feel

### Routes

| Path | Component | Notes |
|---|---|---|
| `/login` | Login | Email + password. Role-based redirect after sign-in |
| `/signup/agent` | AgentSignup | Pending approval flow |
| `/signup/promoter` | PromoterSignup | Supports `?via=` referral code |
| `/dashboard/admin` | Admin Overview | Requires ADMIN role |
| `/dashboard/admin/users` | Admin Users | Approve/reject + full user table |
| `/dashboard/admin/settings` | Admin Settings | System settings form |
| `/dashboard/agent` | Agent Overview | Requires AGENT role |
| `/dashboard/agent/listings` | Agent Listings | Grid view with filter tabs and stats |
| `/dashboard/agent/listings/new` | New Listing | Full creation form with media upload, AI description |
| `/dashboard/agent/listings/edit/:id` | Edit Listing | Same form prefilled, read-only slug, deactivate button |
| `/dashboard/agent/listings/:id` | View Listing | Full read-only detail view with gallery, share, edit button |
| `/dashboard/agent/inquiries` | Agent Inquiries | — |
| `/dashboard/agent/tracking-links` | Tracking Links | — |
| `/dashboard/agent/commissions` | Commissions | — |
| `/dashboard/promoter` | Promoter Overview | Requires PROMOTER role |
| `/dashboard/promoter/promotions` | My Promotions | — |
| `/dashboard/promoter/tracking-links` | Tracking Links | — |
| `/dashboard/promoter/stats` | Stats | — |
| `/dashboard/promoter/commissions` | Commissions | — |

### Dashboard Layout

`components/dashboard/DashboardLayout.tsx` — wraps all dashboard pages with:
- Auth guard (redirects to `/login` if no session or not approved)
- Fixed sidebar (desktop) with role-based navigation
- Top bar with page title, notification bell, user dropdown + sign out
- Mobile bottom tab bar (first 5 nav items)

### Key Source Files

```
webapp/src/
  lib/
    api.ts            — Fetch wrapper, auto-unwraps { data: T }
    auth-client.ts    — Better Auth React client (useSession, signOut)
    types.ts          — Shared TypeScript interfaces (includes videos: string[])
    upload.ts         — File upload utility with client-side image compression
  components/
    listings/
      MediaUpload.tsx  — Drag-and-drop image/video uploader with thumbnails
      NumberStepper.tsx — Stepper for bedrooms/bathrooms (shows — at 0)
  hooks/
    useCurrentUser.ts — Fetches role + approval status
    useNotifications.ts — Notifications list, unread count, mark-read mutations
  components/
    auth/AuthLayout.tsx            — Split-screen auth page layout
    dashboard/DashboardLayout.tsx  — Master dashboard layout
    dashboard/NotificationBell.tsx — Bell with unread badge + popover
  pages/
    auth/Login.tsx
    auth/AgentSignup.tsx
    auth/PromoterSignup.tsx
    dashboard/admin/Overview.tsx
    dashboard/admin/Users.tsx     — Full approve/reject user management
    dashboard/admin/Settings.tsx  — System settings form
    dashboard/agent/...
    dashboard/promoter/...
```
